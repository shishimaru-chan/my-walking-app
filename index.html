<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>おさんぽアプリ</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    html, body {
      margin: 0;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      height: 100vh;
      font-family: sans-serif;
      background: url(background.png);
      overflow: hidden;
    }

    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 20px;
    }

    .screen.active {
      display: flex;
    }
    
    .start_logo{
      width: 95%;
      margin:40px 0;
    }

    .start-btn{
      width: 45%;
    }



    .tittle-route {
      width: 90%;
    }


    #map {
      width: 90%;
      max-width: 500px;
      height: 650px;
      margin: 10px 0 5px 0;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);

    }

    #mapFinal {
      width: 100%;
      max-width: 500px;
      height: 750px;
      margin: -20px 0 5px 0;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .info-area {
      width: 90%;
      max-width: 350px;
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      
    }

    .info-back{
      width: 100%;
      height: auto;
      display: block;
    }

    .info-text{
      margin-top: 345px;
      position: absolute;
      top: 50%;
      left: 45%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: row; /* ← ここが「横並び」のポイント！ */
      justify-content: flex-start;
      z-index: 1;
      width: 100%;
    }
    
    .km-text {
      color: #dffe0f;
      font-size: 40px;
      font-weight: bold;
      width: 180px;
      margin-left:30px;
      margin-right: auto;
    }

    .steps-text {
      color: #dffe0f;
      font-size: 40px;
      font-weight: bold;
      width: 180px;
      margin-right: 60px;
      margin-left: auto;
    }


    .info-btn{
      margin: 0px 30px;
      gap: 100px;
    }

    .icon-btn {
      width: 30%;
      height: auto;
    }

    .fkm-text {
      color: #dffe0f;
      font-size: 40px;
      font-weight: bold;
      width: 180px;
      margin-top: 40px;
      margin-left:30px;
      margin-right: auto;
    }

    .fsteps-text {
      color: #dffe0f;
      font-size: 40px;
      font-weight: bold;
      width: 180px;
      margin-top: 40px;
      margin-right: 60px;
      margin-left: auto;
    }

    #endBtn {
      padding: 0% 28px;
      height: 50px;
      width: auto;
      margin-top: 0%;
    }
  </style>
</head>
<body>

  <!-- スタート画面 -->
  <div id="startScreen" class="screen active">
    <img src="tittle-logo.png" id="tittle-logo" class="start_logo" >
    <img src="start_button.png" id="startRouteBtn" class="start-btn" alt="ルートを作成する">
  </div>

  <!-- ルート作成画面 -->
  <div id="routeScreen" class="screen">
    <img src="tittle-logo.png" class="tittle-route" id="tittle-logo">
    <div id="map">MAP</div>

    <div class="info-area">
      
      <img src="info-back.png" class="info-back">
      <div class="info-text">
        <div class="km-text" id="distance">0.00</div>
        <div class="steps-text" id="steps">0</div>
      </div>

    </div>
    <div class="info-btn">
      <img src="change_route.png" id="changeRouteBtn" class="icon-btn" alt="ルート変更">
      <img src="confirm_route.png" id="confirmRouteBtn" class="icon-btn" alt="決定">
    </div>
  </div>

  <!-- 現在地確認画面 -->
  <div id="finalScreen" class="screen">
    <div id="mapFinal">MAP</div>

    <div class="info-area">
      
     <img src="info-back.png" class="info-back">
     <div class="info-text">
       <div class="fkm-text" id="distanceFinal">0.00</div>
       <div class="fsteps-text" id="stepsFinal">0</div> 
      </div>

    </div>

    <img src="finish_button.png" id="endBtn" class="icon-btn" alt="終了">
  </div>

  <!-- Google Maps API（※あなたのAPIキーに変えてね） -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBgHDP5ocf8VRTKb0Bal1iX0pXK4VmeLvM" defer></script>

  <script>
    let map, mapFinal, directionsService, directionsRendererGo;
    let walkedPath = [];
    let walkedLine = null;
    let currentMarker = null;

    const TARGET_DISTANCE = 3000;
    const TOLERANCE = 500;

    const screens = {
      start: document.getElementById("startScreen"),
      route: document.getElementById("routeScreen"),
      final: document.getElementById("finalScreen")
    };

    function showScreen(name) {
      Object.values(screens).forEach(s => s.classList.remove("active"));
      screens[name].classList.add("active");
    }

    function moveLatLng(lat, lng, distanceMeters, angleDegrees) {
      const R = 6378137;
      const dLat = (distanceMeters * Math.cos((angleDegrees * Math.PI) / 180)) / R;
      const dLng = (distanceMeters * Math.sin((angleDegrees * Math.PI) / 180)) / (R * Math.cos((lat * Math.PI) / 180));
      return {
        lat: lat + (dLat * 180) / Math.PI,
        lng: lng + (dLng * 180) / Math.PI
      };
    }

    function generateRoute(start, attempt = 1) {
      if (attempt > 5) {
        alert("ルートを生成できませんでした");
        return;
      }

      const wp1 = moveLatLng(start.lat, start.lng, 600 + Math.random() * 300, Math.random() * 360);
      const wp2 = moveLatLng(start.lat, start.lng, 800 + Math.random() * 300, Math.random() * 360);

      directionsService.route({
        origin: start,
        destination: start,
        waypoints: [
          { location: wp1, stopover: true },
          { location: wp2, stopover: true }
        ],
        travelMode: google.maps.TravelMode.WALKING
      }, (result, status) => {
        if (status !== "OK") return;

        let total = 0;
        result.routes[0].legs.forEach(leg => total += leg.distance.value);
        const km = (total / 1000).toFixed(2);
        const steps = Math.round(total / 100 * 140);

        document.getElementById("distance").innerText = km;
        document.getElementById("steps").innerText = steps.toLocaleString();

        document.getElementById("distanceFinal").innerText = km;
        document.getElementById("stepsFinal").innerText = steps.toLocaleString();

        if (Math.abs(total - TARGET_DISTANCE) > TOLERANCE) {
          generateRoute(start, attempt + 1);
          return;
        }

        directionsRendererGo.setDirections(result);
      });
    }

    function initMap() {
      if (!navigator.geolocation) {
        alert("位置情報が使えません");
        return;
      }
      
      navigator.geolocation.getCurrentPosition((position) => {
        const start = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };

        map = new google.maps.Map(document.getElementById("map"), {
          center: start,
          zoom: 16
        });

        new google.maps.Marker({ position: start, map, title: "スタート" });

        directionsService = new google.maps.DirectionsService();
        directionsRendererGo = new google.maps.DirectionsRenderer({
          map: map,
          suppressMarkers: true,
          polylineOptions: { strokeColor: "blue", strokeWeight: 4 }
        });
        
        // ✅ watchPosition をここで開始
        navigator.geolocation.watchPosition((position) => {
          const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          // 現在地マーカーを表示・更新
          if (!currentMarker) {
            currentMarker = new google.maps.Marker({
              position: pos,
              map: map,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 6,
                fillColor: "red",
                fillOpacity: 1,
                strokeColor: "white",
                strokeWeight: 2
              }
            });
          } else {
            currentMarker.setPosition(pos);
          }

          // 歩いた経路を保存
          walkedPath.push(pos);

          // 赤い線で歩いたルートを描画
          if (!walkedLine) {
            walkedLine = new google.maps.Polyline({
              path: walkedPath,
              geodesic: true,
              strokeColor: "red",
              strokeOpacity: 1.0,
              strokeWeight: 3,
              map: map
            });
          } else {
            walkedLine.setPath(walkedPath);
          } 
        }, (error) => {
          alert("位置情報が取得できません: " + error.message);
        }, {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 5000

        });

      });
    }
  




    document.getElementById("startRouteBtn").addEventListener("click", () => {
      showScreen("route");
      initMap();
    });

    document.getElementById("changeRouteBtn").addEventListener("click", () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const start = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          generateRoute(start);
        });
      }
    });

    document.getElementById("confirmRouteBtn").addEventListener("click", () => {
      showScreen("final");
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const current = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          mapFinal = new google.maps.Map(document.getElementById("mapFinal"), {
            center: current,
            zoom: 16
          });
          new google.maps.Marker({ position: current, map: mapFinal, title: "現在地" });
        });
      }
    });

    document.getElementById("endBtn").addEventListener("click", () => {
      alert("おつかれさまでした！");
      location.reload(); // アプリ終了風
    });
  </script>
</body>
</html>